<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>spotshare</title>
  </head>

  <body>
    <dialog id="put-tracks-success">
      <p id="html_url"></p>
      <form method="dialog">
        <button>OK</button>
      </form>
    </dialog>
    <form id="put-tracks">
      <p>
        <label
          >GitHub owner<br />
          <input type="text" required id="github-owner" name="github-owner" />
        </label>
      </p>
      <p>
        <label
          >GitHub repo<br />
          <input type="text" required id="github-repo" name="github-repo" />
        </label>
      </p>
      <p>
        <input type="submit" id="submit-put-tracks" disabled />
      </p>
    </form>
    <script type="module">
      import {
        fetchWithErrorHandling,
        parseCallbackParams,
      } from "https://www.danrashid.com/brownies/oauth.js";
      import { Base64 } from "https://cdn.jsdelivr.net/npm/js-base64@3.7.5/base64.mjs";

      const {
        code: spotifyCode,
        clientId: spotifyClientId,
        githubAccessToken,
        spotifyCodeVerifier,
        spotifyRedirectUri,
      } = parseCallbackParams();

      const body = new URLSearchParams({
        grant_type: "authorization_code",
        code: spotifyCode,
        redirect_uri: spotifyRedirectUri,
        client_id: spotifyClientId,
        code_verifier: spotifyCodeVerifier,
      });

      const { access_token: spotifyAccessToken } = await fetchWithErrorHandling(
        "https://accounts.spotify.com/api/token",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: body,
        }
      );

      const fetchWithAccessToken = async (
        url,
        accessToken,
        { headers, ...options } = {}
      ) =>
        await fetchWithErrorHandling(url, {
          headers: {
            Authorization: `Bearer ${accessToken}`,
            ...headers,
          },
          ...options,
        });

      const url = "https://api.spotify.com/v1/me/tracks";
      const limit = 50;

      const { total } = await fetchWithAccessToken(
        `${url}?limit=1`,
        spotifyAccessToken
      );

      const urls = Array(Math.ceil(total / limit))
        .fill(undefined)
        .map((_, i) => `${url}?limit=${limit}&offset=${i * limit}`);

      const tracks = await Promise.all(
        urls.map((url) => fetchWithAccessToken(url, spotifyAccessToken))
      )
        .then((data) =>
          data.reduce(
            (a, datum) => [
              ...a,
              ...datum.items.map(({ track, added_at }) => ({
                id: track.id,
                album: track.album.name,
                artist: track.artists[0].name,
                title: track.name,
                addedAt: new Date(added_at).valueOf(),
              })),
            ],
            []
          )
        )
        .catch((error) => {
          console.error("Error:", error);
        });

      tracks.sort((a, b) => b.addedAt - a.addedAt);

      const content = Base64.encode(JSON.stringify(tracks, undefined, 2));

      const handlePutTracks = async (event) => {
        event.preventDefault();
        const githubOwner = document.getElementById("github-owner").value;
        const githubRepo = document.getElementById("github-repo").value;

        const existingFile =
          (await fetchWithAccessToken(
            `https://api.github.com/repos/${githubOwner}/${githubRepo}/contents/tracks.json`,
            githubAccessToken,
            {
              headers: {
                Accept: "application/vnd.github+json",
                "X-GitHub-Api-Version": "2022-11-28",
              },
            }
          )) || {};

        const {
          content: { html_url },
        } = await fetchWithAccessToken(
          `https://api.github.com/repos/${githubOwner}/${githubRepo}/contents/tracks.json`,
          githubAccessToken,
          {
            method: "PUT",
            headers: {
              Accept: "application/vnd.github+json",
              "X-GitHub-Api-Version": "2022-11-28",
            },
            body: JSON.stringify({
              message: "Updating tracks.json via spotshare",
              content,
              sha: existingFile.sha,
            }),
          }
        );

        document.getElementById(
          "html_url"
        ).innerHTML = `Successfully PUT <a href="${html_url}">${html_url}</a>`;
        document.getElementById("put-tracks-success").show();
      };

      document
        .getElementById("put-tracks")
        .addEventListener("submit", handlePutTracks);

      document.getElementById("submit-put-tracks").disabled = false;
    </script>
  </body>
</html>

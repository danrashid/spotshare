<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>spotshare</title>
  </head>

  <body>
    <script type="module">
      import {
        fetchWithErrorHandling,
        parseCallbackParams,
      } from "https://www.danrashid.com/brownies/oauth.js";
      import { Base64 } from "https://cdn.jsdelivr.net/npm/js-base64@3.7.5/base64.mjs";

      const {
        code: spotifyCode,
        clientId: spotifyClientId,
        githubAccessToken,
        spotifyCodeVerifier,
        spotifyRedirectUri,
      } = parseCallbackParams();

      const body = new URLSearchParams({
        grant_type: "authorization_code",
        code: spotifyCode,
        redirect_uri: spotifyRedirectUri,
        client_id: spotifyClientId,
        code_verifier: spotifyCodeVerifier,
      });

      const { access_token: spotifyAccessToken } = await fetchWithErrorHandling(
        "https://accounts.spotify.com/api/token",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: body,
        }
      );

      const fetchWithAccessToken = async (url, accessToken, options = {}) =>
        await fetchWithErrorHandling(url, {
          headers: {
            Authorization: `Bearer ${accessToken}`,
            ...options.headers,
          },
          ...options,
        });

      const url = "https://api.spotify.com/v1/me/tracks";
      const limit = 50;

      const { total } = await fetchWithAccessToken(
        `${url}?limit=1`,
        spotifyAccessToken
      );

      const urls = Array(Math.ceil(total / limit))
        .fill(undefined)
        .map((_, i) => `${url}?limit=${limit}&offset=${i * limit}`);

      const tracks = await Promise.all(
        urls.map((url) => fetchWithAccessToken(url, spotifyAccessToken))
      )
        .then((data) =>
          data.reduce(
            (a, datum) => [
              ...a,
              ...datum.items.map(({ track, added_at }) => ({
                id: track.id,
                album: track.album.name,
                artist: track.artists[0].name,
                title: track.name,
                addedAt: new Date(added_at).valueOf(),
              })),
            ],
            []
          )
        )
        .catch((error) => {
          console.error("Error:", error);
        });

      tracks.sort((a, b) => b.addedAt - a.addedAt);

      const content = Base64.encode(JSON.stringify(tracks, undefined, 2));
    </script>
  </body>
</html>

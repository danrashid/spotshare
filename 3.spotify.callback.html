<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>spotshare</title>
    <style>
      th {
        text-align: left;
      }
    </style>
  </head>

  <body>
    <table>
      <thead>
        <tr>
          <th>Title</th>
          <th>Album</th>
          <th>Artist</th>
        </tr>
      </thead>
      <tbody id="data"></tbody>
    </table>
    <script type="module">
      import {
        fetchToken,
        fetchWithErrorHandling,
      } from "https://www.danrashid.com/brownies/scripts.js";

      const dataElement = document.getElementById("data");

      function fetchWithAccessToken(url, accessToken, handleSuccess) {
        return fetchWithErrorHandling(
          url,
          {
            headers: {
              Authorization: `Bearer ${accessToken}`,
            },
          },
          handleSuccess
        );
      }

      function fetchTracksAsync(urls, accessToken) {
        urls.forEach((url) => {
          fetchWithAccessToken(url, accessToken, ({ items }) => {
            const trs = [];
            items.forEach(({ track }) => {
              const tr = document.createElement("tr");
              [track.album.name, track.artists[0].name, track.name].forEach(
                (text) => {
                  const td = document.createElement("td");
                  td.appendChild(document.createTextNode(text));
                  tr.appendChild(td);
                }
              );
              trs.push(tr);
            });
            dataElement.append(...trs);
          });
        });
      }

      const url = "https://api.spotify.com/v1/me/tracks";
      const limit = 50;

      fetchToken(({ access_token: accessToken }) =>
        fetchWithAccessToken(`${url}?limit=1`, accessToken, ({ total }) => {
          const urls = [];
          for (let offset = 0; offset < total; offset += limit) {
            urls.push(`${url}?limit=${limit}&offset=${offset}`);
          }
          fetchTracksAsync(urls, accessToken);
        })
      );
    </script>
  </body>
</html>
